name: Auto Deploy to Investyx

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important for delta deployments

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        run: |
          cd broker-client
          npm install
          npm run build

      - name: Prepare Deployment Folder
        run: |
          mkdir deploy_out
          # Copy backend files (contents of broker 2.0)
          cp -r "broker 2.0/." deploy_out/
          # Copy frontend files (contents of broker-client/dist)
          # This will overwrite any duplicates, which is fine as frontend dist is priority for index.html
          cp -r broker-client/dist/. deploy_out/
          # Remove redundant or sensitive files from deployment
          rm -f deploy_out/env.local.php
          rm -rf deploy_out/node_modules

      - name: Sync to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy_out/
          server-dir: /www/investyx/
          # Since we are deploying from a transient folder, git state might be weird.
          # v4.3.4+ handles non-git folders better or we can force it.
          # We don't use clean: true to avoid deleting uploads/ or other server-side data.

      - name: Trigger Deploy Hook
        run: |
          curl -G "https://hollyhop.cz/investyx/deploy_hook.php" \
            --data-urlencode "token=${{ secrets.DEPLOY_TOKEN || 'investyx_secret_123' }}" \
            --data-urlencode "commit_msg=${{ github.event.head_commit.message }}" \
            --data-urlencode "commit_sha=${{ github.sha }}" \
            --data-urlencode "author=${{ github.actor }}"
